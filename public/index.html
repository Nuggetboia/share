<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareView - Screen Sharing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        body.dark-theme {
            background: #1c1c1e;
        }

        body.dark-theme .header {
            background: #2c2c2e;
            color: #f5f5f7;
        }

        body.dark-theme .logo {
            color: #f5f5f7;
        }

        body.dark-theme .btn-secondary {
            background: #3a3a3c;
            color: #f5f5f7;
        }

        body.dark-theme .btn-secondary:hover {
            background: #48484a;
        }

        body.dark-theme .btn-icon {
            background: #3a3a3c;
            color: #f5f5f7;
        }

        body.dark-theme .btn-icon:hover {
            background: #48484a;
        }

        body.dark-theme .placeholder h2 {
            color: #f5f5f7;
        }

        body.dark-theme .placeholder p {
            color: #98989d;
        }

        body.dark-theme .chat-panel {
            background: #2c2c2e;
        }

        body.dark-theme .chat-header {
            border-bottom-color: #3a3a3c;
            color: #f5f5f7;
        }

        body.dark-theme .message-received {
            background: #3a3a3c;
            color: #f5f5f7;
        }

        body.dark-theme .chat-input-container {
            border-top-color: #3a3a3c;
        }

        body.dark-theme .chat-input {
            background: #3a3a3c;
            border-color: #48484a;
            color: #f5f5f7;
        }

        body.dark-theme .modal {
            background: rgba(0,0,0,0.7);
        }

        body.dark-theme .modal-content {
            background: #2c2c2e;
            color: #f5f5f7;
        }

        body.dark-theme .modal-content p {
            color: #98989d;
        }

        body.dark-theme .link-input {
            background: #3a3a3c;
            border-color: #48484a;
            color: #f5f5f7;
        }

        body.dark-theme .sharing-users-panel {
            background: #2c2c2e;
        }

        body.dark-theme .sharing-users-header {
            color: #f5f5f7;
        }

        body.dark-theme .sharing-user-item:hover {
            background: #3a3a3c;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s ease;
        }

        .main-content.chat-open {
            margin-right: 320px;
        }

        .header {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0071e3;
            color: white;
        }

        .btn-primary:hover {
            background: #0077ed;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #ff453a;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f5f7;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .btn-icon:hover {
            background: #e8e8ed;
        }

        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            background: #000;
        }

        .placeholder {
            text-align: center;
            color: #86868b;
        }

        .placeholder h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .placeholder p {
            font-size: 16px;
        }

        .chat-panel {
            position: fixed;
            right: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .chat-panel.open {
            right: 0;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 10px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-sent {
            background: #0071e3;
            color: white;
            align-self: flex-end;
        }

        .message-received {
            background: #f5f5f7;
            align-self: flex-start;
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e5e5e7;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 8px;
        }

        .modal-content p {
            color: #86868b;
            margin-bottom: 24px;
        }

        .link-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .sharing-users-panel {
            position: fixed;
            left: 24px;
            top: 80px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 16px;
            min-width: 200px;
            max-width: 300px;
            display: none;
        }

        .sharing-users-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .sharing-user-item {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .sharing-user-item:hover {
            background: #f5f5f7;
        }

        .sharing-user-item.active {
            background: #0071e3;
            color: white;
        }

        .sharing-badge {
            background: rgba(0,113,227,0.1);
            color: #0071e3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sharing-user-item.active .sharing-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .status-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-theme .status-bar {
            background: #2c2c2e;
            color: #f5f5f7;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #86868b;
        }

        .status-dot.connected {
            background: #34c759;
        }

        .status-dot.sharing {
            background: #ff3b30;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content" id="mainContent">
            <div class="header">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 013 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9z"/>
                    </svg>
                    ShareView
                </div>
                <div class="controls">
                    <button class="btn-secondary" id="startBtn">Start Sharing</button>
                    <button class="btn-danger" id="stopBtn" style="display: none;">Stop Sharing</button>
                    <button class="btn-icon" id="chatToggle" title="Toggle Chat">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5z"/>
                        </svg>
                    </button>
                    <button class="btn-icon" id="themeToggle" title="Toggle Theme">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="video-container" id="videoContainer">
                <div class="placeholder" id="placeholder">
                    <h2>No Active Screen Share</h2>
                    <p>Click "Start Sharing" to share your screen</p>
                </div>
                <video id="videoElement" autoplay playsinline style="display: none;"></video>
            </div>
        </div>

        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <h3>Chat</h3>
                <button class="btn-icon" id="closeChatBtn" style="width: 32px; height: 32px;">Ã—</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
                <button class="btn-primary" id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <h2>Share Your Screen</h2>
            <p>Share this Session ID with others to let them view your screen</p>
            <input type="text" class="link-input" id="shareLink" readonly>
            <div class="modal-buttons">
                <button class="btn-primary" id="copyLinkBtn">Copy ID</button>
                <button class="btn-secondary" id="closeShareModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Sharing Users Panel -->
    <div class="sharing-users-panel" id="sharingUsersPanel">
        <div class="sharing-users-header">Available Sharers</div>
        <div id="sharingUsersList"></div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // DOM Elements
        const videoElement = document.getElementById('videoElement');
        const placeholder = document.getElementById('placeholder');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const shareModal = document.getElementById('shareModal');
        const shareLink = document.getElementById('shareLink');
        const chatPanel = document.getElementById('chatPanel');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const mainContent = document.getElementById('mainContent');
        const sharingUsersPanel = document.getElementById('sharingUsersPanel');
        const sharingUsersList = document.getElementById('sharingUsersList');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // State
        let peer = null;
        let peerId = null;
        let localStream = null;
        let currentCall = null;
        let dataConnection = null;
        let isSharingScreen = false;
        let activeSharers = new Map();
        let currentlyViewing = null;
        let discoveryBroadcast = null;

        // Initialize PeerJS connection
        function initializePeer() {
            console.log('Initializing PeerJS...');
            
            // Connect to PeerJS server
            peer = new Peer({
                host: window.location.hostname,
                port: window.location.port || (window.location.protocol === 'https:' ? 443 : 80),
                path: '/peerjs',
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                peerId = id;
                console.log('âœ… Connected to PeerJS server. My ID:', peerId);
                updateStatus('connected', 'Ready - Click "Start Sharing" or select a sharer below');
                
                // Start broadcasting presence
                startDiscoveryBroadcast();
                
                // Request list of active sharers
                setTimeout(discoverActiveSharers, 1000);
            });

            peer.on('error', (err) => {
                console.error('âŒ PeerJS error:', err);
                if (err.type === 'peer-unavailable') {
                    updateStatus('connected', 'Peer not available');
                } else if (err.type === 'network') {
                    updateStatus('offline', 'Network error - retrying...');
                    setTimeout(initializePeer, 3000);
                } else {
                    updateStatus('offline', 'Error: ' + err.message);
                }
            });

            peer.on('disconnected', () => {
                console.warn('âš ï¸  Disconnected from server');
                updateStatus('offline', 'Disconnected - Reconnecting...');
                peer.reconnect();
            });

            // Handle incoming calls (when someone wants to view our screen)
            peer.on('call', (call) => {
                console.log('ðŸ“ž Incoming call from:', call.peer);
                
                if (isSharingScreen && localStream) {
                    console.log('âœ… Answering with our screen stream');
                    call.answer(localStream);
                    currentCall = call;
                    updateStatus('sharing', 'Sharing with viewers');
                    
                    call.on('close', () => {
                        console.log('Viewer disconnected');
                        if (isSharingScreen) {
                            updateStatus('sharing', 'Sharing (waiting for viewers)');
                        }
                    });

                    call.on('error', (err) => {
                        console.error('Call error:', err);
                    });
                } else {
                    console.warn('âŒ Not sharing, rejecting call');
                    call.close();
                }
            });

            // Handle incoming data connections (for chat and discovery)
            peer.on('connection', (conn) => {
                setupDataConnection(conn);
            });
        }

        // Broadcast that we're sharing (or just present)
        function startDiscoveryBroadcast() {
            // Broadcast our presence every 5 seconds
            discoveryBroadcast = setInterval(() => {
                if (isSharingScreen && peerId) {
                    console.log('ðŸ“¡ Broadcasting that we are sharing...');
                    // We'll use a discovery mechanism through data connections
                }
            }, 5000);
        }

        // Discover active sharers
        function discoverActiveSharers() {
            // In a real app, you'd have a signaling server
            // For now, we'll use manual connection
            console.log('ðŸ” Discovery: Use Session ID to connect to sharers');
        }

        // Start screen sharing
        async function startSharing() {
            try {
                updateStatus('connected', 'Requesting screen share...');
                
                // Request screen sharing with AUDIO
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false,
                        sampleRate: 44100
                    }
                });

                console.log('âœ… Screen sharing started');
                console.log('   Video tracks:', localStream.getVideoTracks().length);
                console.log('   Audio tracks:', localStream.getAudioTracks().length);

                // Check for audio
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    console.log('âœ… Audio enabled:', audioTrack.label);
                } else {
                    console.warn('âš ï¸  No audio track - make sure to check "Share audio"');
                }

                // Display locally
                videoElement.srcObject = localStream;
                videoElement.muted = true; // Mute local to avoid feedback
                videoElement.style.display = 'block';
                placeholder.style.display = 'none';
                
                isSharingScreen = true;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';

                // Show session ID
                shareLink.value = peerId;
                shareModal.classList.add('active');
                updateStatus('sharing', `Sharing - Session ID: ${peerId}`);

                // Add ourselves to the sharers list
                activeSharers.set(peerId, 'You');
                updateSharersList();

                // Handle when user stops sharing via browser
                localStream.getVideoTracks()[0].onended = () => {
                    console.log('ðŸ“º User stopped sharing via browser');
                    stopSharing();
                };

            } catch (err) {
                console.error('âŒ Error starting screen share:', err);
                let errorMsg = 'Could not start screen sharing. ';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'Permission denied.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'No screen source found.';
                } else {
                    errorMsg += err.message;
                }
                
                alert(errorMsg + '\n\nMake sure to:\n1. Grant permission\n2. Select a screen/window\n3. Check "Share audio" for audio');
                updateStatus('connected', 'Ready');
            }
        }

        // Stop screen sharing
        function stopSharing() {
            console.log('ðŸ›‘ Stopping screen share');
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }

            videoElement.srcObject = null;
            videoElement.style.display = 'none';
            placeholder.style.display = 'block';
            
            isSharingScreen = false;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';

            shareModal.classList.remove('active');
            
            // Remove ourselves from sharers list
            activeSharers.delete(peerId);
            updateSharersList();
            
            updateStatus('connected', 'Ready');
        }

        // View another user's screen
        function viewScreen(remotePeerId) {
            if (!peer || !peerId) {
                alert('Not connected to server yet. Please wait...');
                return;
            }

            if (remotePeerId === peerId) {
                alert('This is your own session!');
                return;
            }

            console.log('ðŸ‘ï¸  Attempting to view screen from:', remotePeerId);
            updateStatus('connected', 'Connecting to sharer...');
            currentlyViewing = remotePeerId;
            updateSharersList();

            // Create a silent stream (required for calling)
            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const dst = audioContext.createMediaStreamDestination();
            oscillator.connect(dst);
            oscillator.start();
            const silentStream = dst.stream;

            // Call the remote peer
            const call = peer.call(remotePeerId, silentStream);
            
            if (!call) {
                alert('Could not connect. Check the Session ID.');
                updateStatus('connected', 'Ready');
                currentlyViewing = null;
                updateSharersList();
                return;
            }

            currentCall = call;
            let streamReceived = false;

            call.on('stream', (remoteStream) => {
                streamReceived = true;
                console.log('âœ… Receiving stream with', remoteStream.getTracks().length, 'tracks');
                
                // Display the stream
                videoElement.srcObject = remoteStream;
                videoElement.muted = false; // Enable audio for viewer
                videoElement.style.display = 'block';
                placeholder.style.display = 'none';
                
                stopBtn.style.display = 'inline-block';
                stopBtn.textContent = 'Stop Viewing';
                startBtn.style.display = 'none';
                
                updateStatus('connected', 'Viewing shared screen');

                // Auto-play
                videoElement.play().catch(err => {
                    console.log('Auto-play prevented, user needs to click play');
                });
            });

            call.on('close', () => {
                console.log('ðŸ“ž Call closed');
                leaveViewing();
            });

            call.on('error', (err) => {
                console.error('âŒ Call error:', err);
                alert('Connection failed: ' + err.message);
                leaveViewing();
            });

            // Timeout if no stream
            setTimeout(() => {
                if (!streamReceived) {
                    console.error('âŒ Timeout - no stream received');
                    alert('Could not connect. The session may be inactive or the ID is wrong.');
                    leaveViewing();
                }
            }, 10000);

            // Setup chat connection
            const conn = peer.connect(remotePeerId);
            setupDataConnection(conn);
        }

        // Leave viewing session
        function leaveViewing() {
            console.log('ðŸ‘‹ Leaving viewing session');
            
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }

            if (dataConnection) {
                dataConnection.close();
                dataConnection = null;
            }

            videoElement.srcObject = null;
            videoElement.style.display = 'none';
            placeholder.style.display = 'block';
            
            stopBtn.style.display = 'none';
            stopBtn.textContent = 'Stop Sharing';
            startBtn.style.display = 'inline-block';

            currentlyViewing = null;
            updateSharersList();
            updateStatus('connected', 'Ready');
        }

        // Setup data connection for chat
        function setupDataConnection(conn) {
            conn.on('open', () => {
                console.log('ðŸ’¬ Chat connection established');
                dataConnection = conn;
            });

            conn.on('data', (data) => {
                if (data.type === 'chat') {
                    addMessage(data.message, false);
                }
            });

            conn.on('close', () => {
                console.log('Chat connection closed');
                dataConnection = null;
            });

            conn.on('error', (err) => {
                console.error('Chat connection error:', err);
            });
        }

        // Send chat message
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            if (dataConnection && dataConnection.open) {
                dataConnection.send({ type: 'chat', message });
                addMessage(message, true);
                chatInput.value = '';
            } else {
                alert('No active connection for chat');
            }
        }

        // Add message to chat
        function addMessage(text, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isSent ? 'message message-sent' : 'message message-received';
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Update status
        function updateStatus(type, text) {
            statusDot.className = 'status-dot';
            if (type === 'connected') {
                statusDot.classList.add('connected');
            } else if (type === 'sharing') {
                statusDot.classList.add('sharing');
            }
            statusText.textContent = text;
        }

        // Update sharers list
        function updateSharersList() {
            if (activeSharers.size === 0) {
                sharingUsersPanel.style.display = 'none';
                return;
            }

            sharingUsersPanel.style.display = 'block';
            sharingUsersList.innerHTML = '';

            activeSharers.forEach((name, id) => {
                const item = document.createElement('div');
                item.className = 'sharing-user-item';
                if (currentlyViewing === id) {
                    item.classList.add('active');
                }

                const isYou = id === peerId;
                item.innerHTML = `
                    ${name}
                    ${isYou ? '<span class="sharing-badge">You</span>' : ''}
                `;

                if (!isYou) {
                    item.onclick = () => viewScreen(id);
                }

                sharingUsersList.appendChild(item);
            });
        }

        // Manual add sharer (via prompt)
        function manualAddSharer() {
            const sessionId = prompt('Enter Session ID to view:');
            if (sessionId && sessionId.trim()) {
                activeSharers.set(sessionId.trim(), 'Remote User');
                updateSharersList();
                viewScreen(sessionId.trim());
            }
        }

        // Event Listeners
        startBtn.addEventListener('click', startSharing);
        
        stopBtn.addEventListener('click', () => {
            if (isSharingScreen) {
                stopSharing();
            } else {
                leaveViewing();
            }
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            shareLink.select();
            document.execCommand('copy');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink.value);
            }
            
            const btn = document.getElementById('copyLinkBtn');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy ID', 2000);
        });

        document.getElementById('closeShareModalBtn').addEventListener('click', () => {
            shareModal.classList.remove('active');
        });

        document.getElementById('chatToggle').addEventListener('click', () => {
            chatPanel.classList.toggle('open');
            mainContent.classList.toggle('chat-open');
        });

        document.getElementById('closeChatBtn').addEventListener('click', () => {
            chatPanel.classList.remove('open');
            mainContent.classList.remove('chat-open');
        });

        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', 
                document.body.classList.contains('dark-theme') ? 'dark' : 'light'
            );
        });

        // Add manual connect button to placeholder
        placeholder.innerHTML += '<br><br><button class="btn-primary" onclick="manualAddSharer()" style="margin-top: 16px;">Join Session by ID</button>';

        // Load theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }

        // Initialize on load
        window.addEventListener('load', initializePeer);

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peer) peer.destroy();
        });
    </script>
</body>
</html>
